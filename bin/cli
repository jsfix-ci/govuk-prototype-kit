#!/usr/bin/env node

const fs = require('fs-extra')
const path = require('path')
const { execSync } = require('child_process')

const installDirectory = process.cwd()
const kitRoot = path.join(__dirname, '..')

const copyFile = (fileName) => fs.copy(path.join(kitRoot, fileName), path.join(installDirectory, fileName))
const command = process.argv[2]

function usage () {
  const prog = 'govuk-prototype-kit'
  console.log(`
${prog} <command>

Usage:

${prog} install
${prog} start`
  )
}

;(async () => {
  if (command === 'install') {
    await Promise.all([
      fs.copy(path.join(kitRoot, 'prototype-starter'), installDirectory),
      copyFile('LICENCE.txt'),
      copyFile('.gitignore'),
      copyFile('.nvmrc')
    ])

    // Rename npmrc after the fact because npm will never include a file called .npmrc in a release.
    // See https://docs.npmjs.com/cli/v8/configuring-npm/package-json#files
    await fs.move(path.join(installDirectory, 'npmrc'), path.join(installDirectory, '.npmrc'))

    execSync(`npm install ${kitRoot} govuk-frontend express`, { stdio: 'inherit' })
  } else if (command === 'start') {
    require('../start')
  } else {
    usage()
    process.exitCode = 2
  }
})()
